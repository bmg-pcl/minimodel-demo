<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Model Viewer + AR</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/milligram/1.4.1/milligram.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Barlow+Condensed:wght@400;600&display=swap" rel="stylesheet">
  <script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/3.5.0/model-viewer.min.js"></script>
  <style>
    * { box-sizing: border-box; }

    body {
      font-family: 'Barlow Condensed', sans-serif;
      background: #121212;
      color: #e0e0e0;
      margin: 0;
      display: flex;
      height: 100vh;
      overflow: hidden;
    }

    /* ---- Viewer area ---- */
    #viewer-wrap {
      flex: 1;
      min-width: 0;
      position: relative;
    }

    model-viewer {
      width: 100%;
      height: 100vh;
      background-color: #1a1a1a;
    }

    /* Back link */
    #back-link {
      position: absolute;
      top: 1em;
      left: 1em;
      background: rgba(0,0,0,0.6);
      color: #888;
      text-decoration: none;
      font-size: 0.85em;
      padding: 0.3em 0.7em;
      border: 1px solid #333;
      z-index: 10;
    }
    #back-link:hover { color: #e0e0e0; border-color: #555; }

    /* ---- Sidebar toggle button (shown when sidebar is closed) ---- */
    #toggle-sidebar {
      position: fixed;
      top: 1em;
      right: 1em;
      background: #006400;
      color: #FFD700;
      border: none;
      padding: 0.5em 1em;
      font-family: 'Barlow Condensed', sans-serif;
      font-size: 1em;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      cursor: pointer;
      z-index: 200;
      display: none; /* hidden while sidebar is open */
    }

    /* ---- Sidebar ---- */
    #sidebar {
      width: 300px;
      height: 100vh;
      background: #1a1a1a;
      border-left: 2px solid #2a2a2a;
      display: flex;
      flex-direction: column;
      flex-shrink: 0;
      overflow: hidden;
      transition: width 0.25s ease;
    }
    #sidebar.hidden {
      width: 0;
    }

    .sidebar-header {
      background: #006400;
      color: #FFD700;
      padding: 0.8em 1em;
      font-size: 1.1em;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-shrink: 0;
    }
    .sidebar-header button {
      background: none;
      border: none;
      color: #FFD700;
      cursor: pointer;
      font-size: 1.1em;
      padding: 0;
      line-height: 1;
    }
    .sidebar-header button:hover { color: #fff; }

    .sidebar-scroll {
      flex: 1;
      overflow-y: auto;
      white-space: nowrap; /* prevent text wrapping when animating width */
    }

    .sidebar-section {
      padding: 1em;
      border-bottom: 1px solid #2a2a2a;
      white-space: normal;
    }
    .sidebar-section h4 {
      color: #FFD700;
      margin: 0 0 0.7em 0;
      font-size: 0.95em;
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }

    /* Property table */
    .prop-row {
      display: flex;
      justify-content: space-between;
      gap: 0.5em;
      margin-bottom: 0.45em;
      font-size: 0.95em;
      align-items: baseline;
    }
    .prop-key {
      color: #888;
      flex: 1;
      min-width: 0;
    }
    .prop-val {
      color: #e0e0e0;
      flex: 1.6;
      text-align: right;
      word-break: break-word;
    }
    .prop-val a { color: #bb86fc; }

    /* Settings */
    .setting-row {
      display: flex;
      align-items: center;
      gap: 0.6em;
      margin-bottom: 0.6em;
      font-size: 1em;
      cursor: pointer;
    }
    .setting-row input[type=checkbox] {
      width: 1em;
      height: 1em;
      accent-color: #006400;
      cursor: pointer;
      flex-shrink: 0;
    }
    .setting-row label { cursor: pointer; }
  </style>
</head>
<body>

  <!-- 3D / AR viewer -->
  <div id="viewer-wrap">
    <a id="back-link" href="index.html">&#8592; Viewers</a>
    <model-viewer
      id="mv"
      src="https://bmg-pcl.github.io/minimodel-demo/Mini-Model-2-7213-74-3500-S02.glb"
      ar
      ar-modes="scene-viewer webxr quick-look"
      camera-controls
      auto-rotate
      tone-mapping="neutral"
      shadow-intensity="1"
      shadow-softness="0.88">
    </model-viewer>
  </div>

  <!-- Toggle button (shown when sidebar is closed) -->
  <button id="toggle-sidebar">Properties</button>

  <!-- Sidebar -->
  <div id="sidebar">
    <div class="sidebar-header">
      <span>Properties</span>
      <button id="close-sidebar" title="Close sidebar">&#10005;</button>
    </div>
    <div class="sidebar-scroll">

      <!-- Asset properties from JSON -->
      <div class="sidebar-section">
        <h4>Asset Info</h4>
        <div id="properties"><em style="color:#555">Loading&hellip;</em></div>
      </div>

      <!-- Display settings -->
      <div class="sidebar-section">
        <h4>Display</h4>
        <div class="setting-row">
          <input type="checkbox" id="greyscale">
          <label for="greyscale">Greyscale</label>
        </div>
        <div class="setting-row">
          <input type="checkbox" id="deviceOrientation">
          <label for="deviceOrientation">Device Orientation (gyro)</label>
        </div>
      </div>

    </div>
  </div>

  <script>
    const mv       = document.getElementById('mv');
    const sidebar  = document.getElementById('sidebar');
    const toggleBtn = document.getElementById('toggle-sidebar');
    const closeBtn  = document.getElementById('close-sidebar');

    function openSidebar() {
      sidebar.classList.remove('hidden');
      toggleBtn.style.display = 'none';
    }
    function closeSidebar() {
      sidebar.classList.add('hidden');
      toggleBtn.style.display = '';
    }

    toggleBtn.addEventListener('click', openSidebar);
    closeBtn.addEventListener('click', closeSidebar);
    openSidebar(); // open by default

    // Load asset properties from JSON
    fetch('cable_information.json')
      .then(r => r.ok ? r.json() : Promise.reject(r.statusText))
      .then(data => {
        const div = document.getElementById('properties');
        div.innerHTML = '';
        for (const [key, value] of Object.entries(data)) {
          const row = document.createElement('div');
          row.className = 'prop-row';
          let display;
          if (value === null || value === undefined) {
            display = '<span style="color:#444">—</span>';
          } else if (Array.isArray(value)) {
            display = value.join(', ');
          } else if (typeof value === 'object') {
            display = value.HREF && value.A
              ? `<a href="${value.HREF}" target="_blank" rel="noopener">${value.A}</a>`
              : JSON.stringify(value);
          } else if (typeof value === 'number') {
            display = Number.isInteger(value) ? value : value.toFixed(2);
          } else {
            display = value;
          }
          row.innerHTML = `<span class="prop-key">${key}</span><span class="prop-val">${display}</span>`;
          div.appendChild(row);
        }
      })
      .catch(() => {
        document.getElementById('properties').innerHTML =
          '<em style="color:#555">No properties found.</em>';
      });

    // Greyscale toggle
    document.getElementById('greyscale').addEventListener('change', e => {
      mv.style.filter = e.target.checked ? 'grayscale(100%)' : '';
    });

    // Device Orientation — map gyro to model-viewer cameraOrbit
    let orientationEnabled = false;
    let baseAlpha = null;  // captured on enable so "current heading" = centre
    let baseBeta  = null;

    function onDeviceOrientation(e) {
      if (!orientationEnabled) return;
      const alpha = e.alpha || 0; // compass heading
      const beta  = e.beta  || 0; // front-back tilt
      const gamma = e.gamma || 0; // left-right tilt

      // Capture initial pose so the model stays centred when you enable
      if (baseAlpha === null) { baseAlpha = alpha; baseBeta = beta; }

      // Delta from initial pose → orbit angles
      // theta = horizontal orbit (0-360 deg); phi = vertical orbit (0-180 deg)
      let dAlpha = alpha - baseAlpha;            // left-right
      if (dAlpha > 180) dAlpha -= 360;
      if (dAlpha < -180) dAlpha += 360;

      const dBeta = beta - baseBeta;             // up-down

      const theta = -dAlpha;                     // invert so physical left = orbit left
      const phi   = 75 - dBeta * 0.5;            // 75 deg is model-viewer's default
      const clampedPhi = Math.max(0, Math.min(180, phi));

      mv.cameraOrbit = `${theta}deg ${clampedPhi}deg auto`;
    }

    async function requestOrientationPermission() {
      if (typeof DeviceOrientationEvent !== 'undefined' &&
          typeof DeviceOrientationEvent.requestPermission === 'function') {
        try {
          const state = await DeviceOrientationEvent.requestPermission();
          return state === 'granted';
        } catch { return false; }
      }
      return true;
    }

    document.getElementById('deviceOrientation').addEventListener('change', async (e) => {
      if (e.target.checked) {
        const granted = await requestOrientationPermission();
        if (!granted) { e.target.checked = false; return; }
        baseAlpha = null;
        baseBeta  = null;
        mv.removeAttribute('auto-rotate');      // pause auto-rotate while gyro active
        mv.setAttribute('interaction-prompt', 'none');
        window.addEventListener('deviceorientation', onDeviceOrientation);
        orientationEnabled = true;
      } else {
        orientationEnabled = false;
        window.removeEventListener('deviceorientation', onDeviceOrientation);
        mv.setAttribute('auto-rotate', '');     // resume auto-rotate
        mv.removeAttribute('interaction-prompt');
      }
    });
  </script>

</body>
</html>
